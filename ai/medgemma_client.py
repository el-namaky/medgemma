"""
medgemma_client.py โ MedGemma 4B model loading and inference.
Includes a mock mode for local development without GPU.
"""

import os

# Check if we should use mock mode (no GPU / local development)
USE_MOCK = os.environ.get("MEDGEMMA_MOCK", "true").lower() == "true"

_model = None
_tokenizer = None
_loading_error = None


def load_medgemma():
    """Load MedGemma 4B model with 4-bit quantization."""
    global _model, _tokenizer, _loading_error

    if USE_MOCK:
        print("๐งช Running in MOCK mode โ MedGemma responses will be simulated")
        print("   Set MEDGEMMA_MOCK=false to use real model (requires GPU)")
        _model = "mock"
        _tokenizer = "mock"
        return _model, _tokenizer

    try:
        from transformers import AutoTokenizer, AutoModelForCausalLM
        import torch

        model_name = "google/medgemma-4b-it"
        print(f"๐ง Loading {model_name}...")

        _tokenizer = AutoTokenizer.from_pretrained(model_name)
        _model = AutoModelForCausalLM.from_pretrained(
            model_name,
            torch_dtype=torch.float16,
            load_in_4bit=True,
            device_map="auto"
        )
        print("โ MedGemma loaded successfully")
        return _model, _tokenizer
    except Exception as e:
        print(f"โ๏ธ Failed to load MedGemma: {e}")
        print("๐งช Falling back to MOCK mode")
        _loading_error = str(e)
        _model = "mock"
        _tokenizer = "mock"
        return _model, _tokenizer


def ask_medgemma(prompt, system_prompt="", max_tokens=1024):
    """Send a prompt to MedGemma and get a response."""
    global _model, _tokenizer

    if _model is None:
        load_medgemma()

    if _model == "mock":
        return _generate_mock_response(prompt, system_prompt)

    # Real model inference
    from transformers import AutoTokenizer, AutoModelForCausalLM

    full_prompt = f"{system_prompt}\n\n{prompt}" if system_prompt else prompt

    inputs = _tokenizer(full_prompt, return_tensors="pt").to(_model.device)
    outputs = _model.generate(
        **inputs,
        max_new_tokens=max_tokens,
        temperature=0.3,
        do_sample=True,
        top_p=0.9
    )
    response = _tokenizer.decode(outputs[0], skip_special_tokens=True)

    # Remove the input prompt from the response
    if response.startswith(full_prompt):
        response = response[len(full_prompt):].strip()

    return response


def _generate_mock_response(prompt, system_prompt=""):
    """Generate realistic mock responses for demo/testing."""
    prompt_lower = prompt.lower()

    # Patient summary mock
    if "ููุฎุต" in prompt or "summary" in prompt_lower:
        if "ุณุงุฑุฉ" in prompt or "myasthenia" in prompt_lower:
            return """๐ ููุฎุต ุงูุญุงูุฉ:
- ูุฑูุถุฉ 34 ุณูุฉ ุชุนุงูู ูู Myasthenia Gravis ูุดุฎูุตุฉ ููุฐ 2022
- ุชุชูุงูู Pyridostigmine 60mg ุซูุงุซ ูุฑุงุช ููููุงู
- ุณุงุจูุฉ ุฏุฎูู ุทูุงุฑุฆ ุจุณุจุจ ุชูุงูู MG (ููุงูุฑ 2025) ุจุนุฏ ุฅููุงู ุงูุฏูุงุก

โ๏ธ ุชูุจููุงุช ูููุฉ:
- ๐ด ููุงูุน ุญุฑุฌุฉ: Magnesium, Aminoglycosides, Succinylcholine
- ๐ด ููุงูุน ุนุงููุฉ: Beta-blockers, Fluoroquinolones
- โ๏ธ ูุฌุจ ูุฑุงูุจุฉ ูุธุงุฆู ุงูุชููุณ ุนู ูุซุจ

๐ ุงูุฃุฏููุฉ ุงูุญุงููุฉ:
- Pyridostigmine 60mg ร 3 ููููุงู (ูุซุจุท ูููููุณุชุฑุงุฒ)"""

        elif "ุนุจุฏ ุงููู" in prompt:
            return """๐ ููุฎุต ุงูุญุงูุฉ:
- ูุฑูุถ 56 ุณูุฉ ูุนุงูู ูู ูุตูุฑ ูู ุงูุดุฑูุงู ุงูุชุงุฌู + ุงุฑุชูุงุน ุถุบุท ุงูุฏู
- ุชู ุชุฑููุจ ุฏุนุงูุฉ ููุจูุฉ (LAD) ูู 2023
- ุณุงุจูุฉ ุฏุฎูู ุทูุงุฑุฆ ุจุฐุจุญุฉ ุตุฏุฑูุฉ ุบูุฑ ูุณุชูุฑุฉ (ููููุจุฑ 2024)

โ๏ธ ุชูุจููุงุช ูููุฉ:
- ๐ด ูููุน NSAIDs (ุฎุทุฑ ููุจู ูุนุงุฆู)
- โ๏ธ LDL ูุฑุชูุน (145 mg/dL) โ ูุญุชุงุฌ ูุชุงุจุนุฉ

๐ ุงูุฃุฏููุฉ ุงูุญุงููุฉ:
- Aspirin 75mg ููููุงู โ Atorvastatin 20mg โ Bisoprolol 5mg"""

        elif "ุฃุญูุฏ" in prompt:
            return """๐ ููุฎุต ุงูุญุงูุฉ:
- ูุฑูุถ 58 ุณูุฉ ูุนุงูู ูู ุงุฑุชูุงุน ุถุบุท ุงูุฏู + ุณูุฑู ููุน 2
- ุงูุณูุฑู ุบูุฑ ููุถุจุท (HbA1c: 7.2%)
- ๐ด ุญุณุงุณูุฉ ุดุฏูุฏุฉ ูู ุงูุจูุณููู (ุตุฏูุฉ ุชุญุณุณูุฉ ุณุงุจูุฉ)

โ๏ธ ุชูุจููุงุช ูููุฉ:
- ๐ด ููููุน ูุตู Penicillin ุฃู ูุดุชูุงุชู โ ุชุงุฑูุฎ Anaphylaxis
- โ๏ธ ุชุฌูุจ Corticosteroids (ุชุฑูุน ุงูุณูุฑ)

๐ ุงูุฃุฏููุฉ ุงูุญุงููุฉ:
- Amlodipine 5mg โ Metformin 500mg ร 2"""

        elif "ูุญููุฏ" in prompt:
            return """๐ ููุฎุต ุงูุญุงูุฉ:
- ูุฑูุถ 41 ุณูุฉ ูุนุงูู ูู ุงูุฑุจู
- ุณุงุจูุฉ ุฏุฎูู ุทูุงุฑุฆ ุจููุจุฉ ุฑุจู ุญุงุฏุฉ (ุฏูุณูุจุฑ 2024)
- ๐ด ุญุณุงุณูุฉ ุดุฏูุฏุฉ ูู Aspirin (ุชุดูุฌ ูุตุจู)

โ๏ธ ุชูุจููุงุช ูููุฉ:
- ๐ด ููููุน Beta-blockers (ุชุถูู ุดุนุจู)
- ๐ด ููููุน Aspirin ู NSAIDs (ุชูุงูู ุงูุฑุจู)

๐ ุงูุฃุฏููุฉ ุงูุญุงููุฉ:
- Salbutamol ุจุฎุงุฎ ุนูุฏ ุงูุญุงุฌุฉ"""

        else:
            return """๐ ููุฎุต ุงูุญุงูุฉ:
- ูุฑูุถุฉ 31 ุณูุฉ โ ูุง ุฃูุฑุงุถ ูุฒููุฉ
- ุญุณุงุณูุฉ ุฎูููุฉ ูู ุฃุฏููุฉ Sulfa (ุทูุญ ุฌูุฏู)
- ุชุงุฑูุฎ ุนุงุฆูู: ุงูุฃู ูุตุงุจุฉ ุจุงูุณูุฑู

โ๏ธ ุชูุจููุงุช ูููุฉ:
- โ๏ธ ุชุฌูุจ ุฃุฏููุฉ Sulfa
- ูุนูููุงุชู: ุชุงุฑูุฎ ุนุงุฆูู ููุณูุฑู โ ูููุตุญ ุจูุญุต ุฏูุฑู

๐ ุงูุฃุฏููุฉ ุงูุญุงููุฉ:
- ูุง ุชูุฌุฏ ุฃุฏููุฉ ุญุงููุฉ"""

    # Diagnosis loop mock
    if "ูุญูู ุทุจู" in prompt or "ุชุดุฎูุต ูุนูู" in prompt or "detective" in prompt_lower:
        if "myasthenia" in prompt_lower or "ุถุนู ุนุงู" in prompt or "ูุบููุณููู" in prompt:
            return """[ุฎุทูุฉ 1]: ุฌูุน ุงูุจูุงูุงุช ูู ุงูุณุฌู ุงูุทุจู...
   โ ุงููุฑูุถุฉ ุณุงุฑุฉ ุฎุงูุฏุ 34 ุณูุฉ
   โ ูุตุงุจุฉ ุจู Myasthenia Gravis ููุฐ 2022
   โ ุชุชูุงูู Pyridostigmine 60mg ร 3 ููููุงู
   โ ุณุงุจูุฉ ุชูุงูู MG ูู ููุงูุฑ 2025 ุจุนุฏ ุฅููุงู ุงูุฏูุงุก

[ุฎุทูุฉ 2]: ุชุญููู ุงูุนูุงูุฉ ุจูู ุงูุดููู ูุงูุชุงุฑูุฎ...
   โ ุงูุดููู "ุถุนู ุนุงู + ุตุนูุจุฉ ุจูุน" ูุชูุงููุฉ ูุน ุชูุงูู MG
   โ Anti-AChR Antibodies ุณุงุจูุงู: 15.2 nmol/L (ุฅูุฌุงุจูุฉ ูููุฉ)
   โ ุงุญุชูุงู: ุฃุฒูุฉ Myasthenic Crisis (ุซูุฉ ูุจุฏุฆูุฉ: 65%)

[ุฎุทูุฉ 3]: ุงูุจุญุซ ุนู ุฃุฏูุฉ ุฅุถุงููุฉ...
   โ ูู ุงููุญุงุฏุซุฉ/ุงููุฏุฎูุงุช: ุงููุฑูุถุฉ ุชูุงููุช ูุบููุณููู
   โ ๐ด ุชุทุงุจู ูุน ุฌุฏูู contraindications:
      Magnesium + Myasthenia Gravis = CRITICAL
      ุงูุณุจุจ: ูุซุจุท ุงูููู ุงูุนุตุจู ุงูุนุถูู (NMJ)
   โ ูุฐุง ููุณุฑ ุงูุชูุงูู ุงูููุงุฌุฆ
   โ ุซูุฉ ุงูุขู: 90%

[ุฎุทูุฉ 4]: ุงูุชุญูู ูุงูุชุฃููุฏ...
   โ ุงูุชุณูุณู ุงูุฒููู ููุทูู: ุชูุงูู ูุบููุณููู โ ุชุซุจูุท NMJ โ ุชูุงูู ุงูุถุนู
   โ ุงูุฃุนุฑุงุถ (ุถุนู ุนุงู + ุตุนูุจุฉ ุจูุน) ุชุชูุงูู ูุน Myasthenic Crisis
   โ ูุง ุชูุฌุฏ ุชูุณูุฑุงุช ุจุฏููุฉ ุฃููู

[ุงููุชูุฌุฉ]: ุชูุงูู Myasthenia Gravis ุจุณุจุจ ุชูุงูู ูุบููุณููู โ ูุณุจุฉ ุงูุซูุฉ: 90%

[๐ด ุงูุชุฑุงุญุงุช ุญูุฑุงุก โ ุชุญุงููู/ุฃุดุนุฉ]:
โข Anti-AChR Antibodies โ ูุชูููู ูุดุงุท ุงููุฑุถ
โข Electrolytes Panel โ ูููุงุณ ูุณุชูู ุงููุบููุณููู ุงููุนูู
โข ABG โ ุบุงุฒุงุช ุฏู ุดุฑูุงูู ูุชูููู ุงูุชููุณ
โข Pulmonary Function Test โ ูุชูููู ุงููุธููุฉ ุงูุชููุณูุฉ
โข ูุฑุงูุจุฉ Forced Vital Capacity ูู ุณุงุนุฉ

[๐ด ุชุญุฐูุฑุงุช]:
โ๏ธ ุชุญุฐูุฑ ุญุฑุฌ: ุงููุฑูุถุฉ ุชูุงููุช ูุบููุณููู ููู ุชุนุงูู MG
   โ ุงููุบููุณููู ูุซุจุท NMJ ูููุงูู ุงูุถุนู ุจุดูู ุฎุทูุฑ
   โ ุฎุทุฑ ูุดู ุชููุณู โ ูุฑุงูุจุฉ ุชููุณูุฉ ูุณุชูุฑุฉ ูุทููุจุฉ

โ๏ธ ุชุฌูุจ ูุตู ุฃู ูู ุงูููุงุฏ ุงูุชุงููุฉ:
   โข Aminoglycosides (critical)
   โข Succinylcholine (critical)
   โข Beta-blockers (high)
   โข Fluoroquinolones (high)"""

        return """[ุฎุทูุฉ 1]: ุฌูุน ุงูุจูุงูุงุช ูู ุงูุณุฌู ุงูุทุจู...
   โ ุชู ุณุญุจ ุงูุณุฌู ุงููุงูู ูุชุญููู ุงูุจูุงูุงุช

[ุฎุทูุฉ 2]: ุชุญููู ุงูุนูุงูุฉ ุจูู ุงูุดููู ูุงูุชุงุฑูุฎ...
   โ ุฌุงุฑู ุชุญููู ุงูุนูุงูุฉ ุจูู ุงูุฃุนุฑุงุถ ูุงูุชุงุฑูุฎ ุงููุฑุถู

[ุฎุทูุฉ 3]: ุงูุจุญุซ ุนู ุฃุฏูุฉ ุฅุถุงููุฉ...
   โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุชุนุงุฑุถุงุช ุญุฑุฌุฉ

[ุฎุทูุฉ 4]: ุงูุชุญูู ูุงูุชุฃููุฏ...
   โ ูุญุชุงุฌ ูุฒูุฏ ูู ุงููุนูููุงุช ููุชุดุฎูุต ุงูุฏููู

[ุงููุชูุฌุฉ]: ูููุตุญ ุจุฅุฌุฑุงุก ูุญูุตุงุช ุฅุถุงููุฉ ูููุตูู ูุชุดุฎูุต ููุงุฆู โ ูุณุจุฉ ุงูุซูุฉ: 40%

[๐ด ุงูุชุฑุงุญุงุช ุญูุฑุงุก โ ุชุญุงููู/ุฃุดุนุฉ]:
โข CBC โ ุชุนุฏุงุฏ ุฏู ุดุงูู
โข CMP โ ููุญุฉ ุฃูุถ ุดุงููุฉ

[๐ด ุชุญุฐูุฑุงุช]:
ูุง ุชูุฌุฏ ุชุญุฐูุฑุงุช ุญุฑุฌุฉ ุญุงููุงู"""

    # Conversation analysis mock
    if "ุญูู ุงููุญุงุฏุซุฉ" in prompt or "ูุญุงุฏุซุฉ" in prompt:
        if "ูุบููุณููู" in prompt:
            return """1. **ุงูุฃุนุฑุงุถ ุงููุฐููุฑุฉ:**
   - ุถุนู ุนุงู ูู ุงูุฌุณู
   - ุตุนูุจุฉ ูู ุงูุจูุน
   - ุฅุฑูุงู ุดุฏูุฏ

2. **ููุงุฏ/ุฃุฏููุฉ ุฐููุฑุช:**
   - ๐ด ูุบููุณููู (ุชูุงููุชู ุงููุฑูุถุฉ ุจุฌุฑุนุฉ ุนุงููุฉ)

3. **ูุนูููุงุช ูู ุชูุณุฌููู:**
   - ุงููุฑูุถุฉ ูุฏ ุชููู ุฃูููุช ุฃู ูููุช ุฌุฑุนุฉ Pyridostigmine

4. **ุงูุชุฑุงุญุงุช ููุก ุงูุญููู:**
   - ุงูุดููู ุงูุฑุฆูุณูุฉ: ุถุนู ุนุงู + ุตุนูุจุฉ ุจูุน
   - ูุง ุชูุงููู ูุจู ุงูุญุถูุฑ: ูุบููุณููู ุจุฌุฑุนุฉ ุนุงููุฉ

5. **๐ด ุชูุจููุงุช ุนุงุฌูุฉ:**
   - ุงููุบููุณููู + Myasthenia Gravis = ุฎุทุฑ ุญุฑุฌ!
   - ูุซุจุท ุงูููู ุงูุนุตุจู ุงูุนุถูู โ ุฎุทุฑ ุฃุฒูุฉ ุชููุณูุฉ"""

        return """1. **ุงูุฃุนุฑุงุถ ุงููุฐููุฑุฉ:**
   - ุชู ุชุญููู ุงููุญุงุฏุซุฉ

2. **ููุงุฏ/ุฃุฏููุฉ ุฐููุฑุช:**
   - ูู ูุชู ุฐูุฑ ููุงุฏ ุฎุทุฑุฉ

3. **ูุนูููุงุช ูู ุชูุณุฌููู:**
   - ูุง ุชูุฌุฏ ูุนูููุงุช ุฌุฏูุฏุฉ

4. **ุงูุชุฑุงุญุงุช ููุก ุงูุญููู:**
   - ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุญููู ูุฏููุงู

5. **ุชูุจููุงุช ุนุงุฌูุฉ:**
   - ูุง ุชูุฌุฏ ุชูุจููุงุช ุนุงุฌูุฉ"""

    # Suggestions mock
    if "ุงูุชุฑุงุญุงุช" in prompt or "suggestion" in prompt_lower:
        return """1. **ุชุญุงููู ุฅุถุงููุฉ ููุชุฑุญุฉ:**
   - CBC โ ุชุนุฏุงุฏ ุฏู ุดุงูู (ุฃุณุงุณู)
   - CRP โ ุจุฑูุชูู ุงูุชูุงุนูู (ูุชูููู ุงูุงูุชูุงุจ)
   - Electrolytes โ ูุชูููู ุชูุงุฒู ุงูุฃููุงุญ

2. **ุชุดุฎูุตุงุช ูุญุชููุฉ:**
   - ุงูุชุดุฎูุต ุงูุฃููู ูุญุชุงุฌ ูุฒูุฏ ูู ุงููุนูููุงุช (ุซูุฉ: 50%)

3. **ุฃุณุฆูุฉ ูุฌุจ ุฃู ูุณุฃููุง ุงูุทุจูุจ:**
   - ูู ุชูุงููุช ุฃู ุฃุฏููุฉ ุฃู ููููุงุช ูุคุฎุฑุงูุ
   - ููุฐ ูุชู ุจุฏุฃุช ุงูุฃุนุฑุงุถ ุจุงูุถุจุทุ
   - ูู ููุงู ุชุงุฑูุฎ ุนุงุฆูู ูุฃูุฑุงุถ ูุดุงุจูุฉุ

4. **ุชุญุฐูุฑุงุช:**
   - ูุง ุชูุฌุฏ ุชุญุฐูุฑุงุช ุฅุถุงููุฉ ุญุงููุงู"""
    
    # First Aid / Choking Mock (Added for user request)
    if "ุงุฎุชูุงู" in prompt or "choking" in prompt_lower or "ุงุณุนุงูุงุช" in prompt:
         return """๐ **ุงูุฅุณุนุงูุงุช ุงูุฃูููุฉ ููุงุฎุชูุงู (Choking):**
    
    1. **ุดุฌุน ุงููุตุงุจ ุนูู ุงูุณุนุงู** ุฅุฐุง ูุงู ูุณุชุทูุน ุงูุชููุณ ุฌุฒุฆูุงู.
    2. **ุถุฑุจุงุช ุงูุธูุฑ (Back Blows):**
       - ูู ุฎูู ุงููุตุงุจ ูุงุณูุฏู ุจูุฏ ูุงุญุฏุฉ.
       - ุงุถุฑุจ ุจููุฉ 5 ูุฑุงุช ุจูู ููุญู ุงููุชู ุจูุนุจ ูุฏู ุงูุฃุฎุฑู.
    3. **ุถุบุทุงุช ุงูุจุทู (ููุงูุฑุฉ ูููููู - Heimlich Maneuver):**
       - ูู ุฎูู ุงููุตุงุจ ููู ุฐุฑุงุนูู ุญูู ุฎุตุฑู.
       - ุงูุจุถ ูุฏู ูุถุนูุง ููู ุงูุณุฑุฉ (ุชุญุช ุงูููุต ุงูุตุฏุฑู).
       - ุงุถุบุท ุจููุฉ ููุฏุงุฎู ููุฃุนูู 5 ูุฑุงุช.
    4. **ูุฑุฑ:** 5 ุถุฑุจุงุช ุธูุฑ ุซู 5 ุถุบุทุงุช ุจุทู ุญุชู ูุฎุฑุฌ ุงูุฌุณู ุงูุบุฑูุจ.
    
    โ๏ธ **ุฅุฐุง ููุฏ ุงููุตุงุจ ุงููุนู:** ุงุจุฏุฃ ุงูุฅูุนุงุด ุงูููุจู ุงูุฑุฆูู (CPR) ููุฑุงู ูุงุชุตู ุจุงูุทูุงุฑุฆ."""

    # Generic Mock Response with Loading Status Check
    status_msg = ""
    # Check if _loading_error global exists (it might not if imported partially)
    try:
        if _loading_error:
            status_msg = f"\n\nโ๏ธ **ุชูุจูู:** ูุดู ุชุญููู ุงูููุฏูู ุงูุญูููู ({_loading_error}).\nุฃุนูู ุญุงููุงู ุจูุถุน ุงููุญุงูุงุฉ (Demo Mode)."
        else:
             status_msg = "\n\nโ๏ธ **ุชูุจูู:** ุฃุนูู ุจูุถุน ุงููุญุงูุงุฉ (Demo Mode) ูุฃู ุงูุงุชุตุงู ุจุงููููุฐุฌ ุบูุฑ ูุดุท."
    except NameError:
        status_msg = "\n\nโ๏ธ **ุชูุจูู:** ุฃุนูู ุจูุถุน ุงููุญุงูุงุฉ (Demo Mode)."

    return f"โ๏ธ **ูุถุน ุงููุญุงูุงุฉ:** ูู ุฃุชููู ูู ููู ูุฐุง ุงูุณุคุงู ูู ุงููุถุน ุงูุชุฌุฑูุจู.\n\nุงูุณุคุงู: {prompt}\n\nูุฑุฌู ุงูุชุฃูุฏ ูู ุชุดุบูู ุงููููุฐุฌ ุงูุญูููู ุนูู Colab ููุญุตูู ุนูู ุฅุฌุงุจุงุช ุบูุฑ ูุญุฏูุฏุฉ.{status_msg}"
